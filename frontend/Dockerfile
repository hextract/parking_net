FROM node:20-alpine AS build

WORKDIR /app

# Base configuration (matches root .env)
ARG VITE_BASE_HOST
ARG VITE_NGINX_PORT
ARG VITE_AUTH_REST_PORT
ARG VITE_PARKING_REST_PORT
ARG VITE_BOOKING_REST_PORT
ARG VITE_PAYMENT_REST_PORT
ARG VITE_KEYCLOAK_PORT
ARG VITE_JAEGER_PORT
ARG VITE_PROMETHEUS_PORT
ARG VITE_GRAFANA_PORT

ENV VITE_BASE_HOST=${VITE_BASE_HOST:-localhost}
ENV VITE_NGINX_PORT=${VITE_NGINX_PORT:-80}
ENV VITE_AUTH_REST_PORT=${VITE_AUTH_REST_PORT:-8800}
ENV VITE_PARKING_REST_PORT=${VITE_PARKING_REST_PORT:-8888}
ENV VITE_BOOKING_REST_PORT=${VITE_BOOKING_REST_PORT:-8880}
ENV VITE_PAYMENT_REST_PORT=${VITE_PAYMENT_REST_PORT:-8890}
ENV VITE_KEYCLOAK_PORT=${VITE_KEYCLOAK_PORT:-8080}
ENV VITE_JAEGER_PORT=${VITE_JAEGER_PORT:-16686}
ENV VITE_PROMETHEUS_PORT=${VITE_PROMETHEUS_PORT:-9090}
ENV VITE_GRAFANA_PORT=${VITE_GRAFANA_PORT:-3000}

# Optional: Override with full URLs if needed
ARG VITE_API_BASE_URL
ARG VITE_AUTH_SERVICE_URL
ARG VITE_PARKING_SERVICE_URL
ARG VITE_BOOKING_SERVICE_URL
ARG VITE_PAYMENT_SERVICE_URL
ARG VITE_KEYCLOAK_URL
ARG VITE_AUTH_METRICS_URL
ARG VITE_PARKING_METRICS_URL
ARG VITE_BOOKING_METRICS_URL
ARG VITE_PAYMENT_METRICS_URL
ARG VITE_JAEGER_URL
ARG VITE_PROMETHEUS_URL
ARG VITE_GRAFANA_URL
ARG VITE_JAEGER_SUBDOMAIN
ARG VITE_PROMETHEUS_SUBDOMAIN
ARG VITE_GRAFANA_SUBDOMAIN
ARG VITE_KEYCLOAK_SUBDOMAIN

ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
ENV VITE_AUTH_SERVICE_URL=${VITE_AUTH_SERVICE_URL}
ENV VITE_PARKING_SERVICE_URL=${VITE_PARKING_SERVICE_URL}
ENV VITE_BOOKING_SERVICE_URL=${VITE_BOOKING_SERVICE_URL}
ENV VITE_PAYMENT_SERVICE_URL=${VITE_PAYMENT_SERVICE_URL}
ENV VITE_KEYCLOAK_URL=${VITE_KEYCLOAK_URL}
ENV VITE_AUTH_METRICS_URL=${VITE_AUTH_METRICS_URL}
ENV VITE_PARKING_METRICS_URL=${VITE_PARKING_METRICS_URL}
ENV VITE_BOOKING_METRICS_URL=${VITE_BOOKING_METRICS_URL}
ENV VITE_PAYMENT_METRICS_URL=${VITE_PAYMENT_METRICS_URL}
ENV VITE_JAEGER_URL=${VITE_JAEGER_URL}
ENV VITE_PROMETHEUS_URL=${VITE_PROMETHEUS_URL}
ENV VITE_GRAFANA_URL=${VITE_GRAFANA_URL}
ENV VITE_JAEGER_SUBDOMAIN=${VITE_JAEGER_SUBDOMAIN}
ENV VITE_PROMETHEUS_SUBDOMAIN=${VITE_PROMETHEUS_SUBDOMAIN}
ENV VITE_GRAFANA_SUBDOMAIN=${VITE_GRAFANA_SUBDOMAIN}
ENV VITE_KEYCLOAK_SUBDOMAIN=${VITE_KEYCLOAK_SUBDOMAIN}

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
